<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>Mooltipass: Mooltipass AES description</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="0_Mooltipass.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Mooltipass
   </div>
   <div id="projectbrief">Offline Password Keeper</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Mooltipass AES description </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>1- AES LIBRARY </h2>
<p>In order to avoid conflicts with the GPL license of AVR Cryptolib we have decided to change the AES Library to <a href="http://www.literatecode.com/aes256">http://www.literatecode.com/aes256</a>.</p>
<p>To avoid changes in the current CTR implementation we decided to do some #define and avoid changing function names and those things.</p>
<p>Changes made from the original library to avoid changes in other files: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;aes.c:</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;1.Uncomment &#39;#define BACK_TO_TABLES&#39;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;2.Add sbox and sboxinv to flash memory:</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;const uint8_t sbox[256] __attribute__ ((__progmem__)) = {...};</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;const uint8_t sboxinv[256] __attribute__ ((__progmem__)) = {...};</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;3.Modify #define of rj_sbox and rj_sbox_inv to:</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;#define rj_sbox(x)     (pgm_read_byte(&amp;sbox[x]))</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;#define rj_sbox_inv(x) (pgm_read_byte(&amp;sboxinv[x]))</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;4.Change aes_init function name to aes256_init_ecb</div></div><!-- fragment --> <div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;aes.h:</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;1- Add &#39;#define&#39; inside the header file</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;#define aes256_ctx_t aes256_context</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;#define aes256_init(x,y)    aes256_init_ecb((y),(uint8_t*)(x))</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;#define aes256_enc(x,y)     aes256_encrypt_ecb((y),(uint8_t*)(x))</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;#define aes256_dec(x,y)     aes256_decrypt_ecb((y),(uint8_t*)(x))</div></div><!-- fragment --><p>How to use the library? How to work with it ? As easy as it sounds, you only have to care about 3 functions: aes256_init, aes256_enc and aes256_dec. Here it is a simple example:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;void aes256_test(void)</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;{</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;    // aes256 is 32 byte key</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    uint8_t key[32] = {0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20, 21,22,23,24,25,26,27,28,29,30,31};</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;    // aes256 is 16 byte data size</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;    uint8_t data[16] = &quot;text to encrypt&quot;;</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;    // declare the context where the round keys are stored</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;    aes256_ctx_t ctx;</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;    // Initialize the AES256 with the desired key</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;    aes256_init(key, &amp;ctx);</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;    // Encrypt data</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;    // &quot;text to encrypt&quot; (ascii) -&gt; &#39;9798D10A63E4E167122C4C07AF49C3A9&#39;(hex)</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;    aes256_enc(data, &amp;ctx);</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;    // Decrypt data</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;    // &#39;9798D10A63E4E167122C4C07AF49C3A9&#39;(hex) -&gt; &quot;text to encrypt&quot; (ascii)</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;    aes256_dec(data, &amp;ctx);</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;}</div></div><!-- fragment --><h2>2- Testing the library using nessie test vectors </h2>
<p>After downloading a third party library or resource you must ensure the library performs the function as well as it is claimed. So to satisfy our paranoia against any bug or error with the library, we have checked the encryption and decryption using different test vectors, called Nessie Test Vectors. There are 8 different sets of test vectors, we have checked AES256 against all.</p>
<p>To test AES256 using nessie vectors, we have created a file called <a class="el" href="aes256__nessie__test_8c.html" title="Different functions to check AES256 using nessie test vectors.   see https://www.cosic.esat.kuleuven.be/nessie/testvectors/   Block Cipher -&gt; Rijndael -&gt; key size 256.   To verify the output of tests, do a log with output and see differences with a diff viewer.  . ">aes256_nessie_test.c</a>. This file outputs the results of nessie test into UART, USB CDC or whatever function you want. You only have to initialize the function pointer to print the output where you want.</p>
<p>Sample code to print the output through USB CDC:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;#include &quot;aes256_nessie_test.h&quot;</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;void main(void)</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;{</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;    /*</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;        INITIALIZATION OF USB CDC</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;    */</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;    // Redirect nessieOutput to usb_serial_putchar</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;    nessieOutput = &amp;usb_serial_putchar;</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;    // Test all sets of nessie vectors</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;    nessieTest(1);</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;    nessieTest(2);</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;    nessieTest(3);</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;    nessieTest(4);</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;    nessieTest(5);</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;    nessieTest(6);</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;    nessieTest(7);</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;    nessieTest(8);</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;}</div></div><!-- fragment --><p>Nessie test vectors and output are located in <a href="https://www.cosic.esat.kuleuven.be/nessie/testvectors">https://www.cosic.esat.kuleuven.be/nessie/testvectors</a> Block Cipher -&gt; Rijndael -&gt; key size 256.</p>
<p>The output of all nessieTest functions are formatted in the same way as the file <b>aes256_nessie_test.txt</b>, so... you must save the output (using cutecom or similar hyperterminal program) into a file and check the differences between your file and <b>aes256_nessie_test.txt</b> using a diff viewer.</p>
<h2>3- CTR block encryption </h2>
<p>The passwords stored on the mooltipass will be encrypted using CTR block encryption, more information in: <a href="http://en.wikipedia.org/wiki/Block_cipher_mode_of_operation#Counter_.28CTR.29">Counter CTR </a>. We must decide how to generate the initialization vector. Here's an example of use of CTR encryption and decryption.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;static uint8_t key[32] = { 0x60, 0x3d, 0xeb, 0x10, 0x15, 0xca, 0x71, 0xbe, 0x2b,</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;0x73, 0xae, 0xf0, 0x85, 0x7d, 0x77, 0x81, 0x1f, 0x35, 0x2c, 0x07, 0x3b,</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;0x61, 0x08, 0xd7, 0x2d, 0x98, 0x10, 0xa3, 0x09, 0x14, 0xdf, 0xf4 };</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;static uint8_t iv[16] = { 0xf0, 0xf1, 0xf2, 0xf3, 0xf4, 0xf5, 0xf6, 0xf7, 0xf8,</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;0xf9, 0xfa, 0xfb, 0xfc, 0xfd, 0xfe, 0xff };</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;char text[32] = &quot;this is my pass to encrypt&quot;;</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;void main(void)</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;{</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;    /*</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;        Stuff here</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;    */</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;    // Declare aes256 context variable</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;    aes256CtrCtx_t ctx;</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;    // Save key and initialization vector inside context</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;    aes256CtrInit(&amp;ctx, key, iv, 16);</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;    aes256CtrEncrypt(&amp;ctx, text, sizeof(text));</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;    // here array pass has been encrypted inside text</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;    /*</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;        Decrypt</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;    */</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;    aes256CtrDecrypt(&amp;ctx, text, sizeof(text));</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;    // decrypting make text to be &quot;this is my pass to encrypt&quot; again.</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;}</div></div><!-- fragment --><p> Data input in aes256CtrEncrypt and aes256CtrDecrypt must be multiple of 16 bytes length.</p>
<p>As said, we like to test our code and verify it has no bugs so... you can test CTR encryption implementation by using <b><a class="el" href="aes256__ctr__test_8c.html" title="Different functions to check AES256CTR encryption. ">aes256_ctr_test.c</a></b> functions and doing a diff against <b>aes256_ctr_test.txt</b>. CTR vectors used in aes256CtrTest are from <a href="http://csrc.nist.gov/publications/nistpubs/800-38a/sp800-38a.pdf">http://csrc.nist.gov/publications/nistpubs/800-38a/sp800-38a.pdf</a>. </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;void main(void)</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;{</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    /*</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;        INITIALIZATION OF USB CDC</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;    */</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;    // Redirect ctrTestOutput to usb_serial_putchar function</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;    ctrTestOutput = &amp;usb_serial_putchar;</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;    aes256CtrTest();</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;}</div></div><!-- fragment --><h2>4- Description of files </h2>
<ul>
<li>AVR-cryptolib files used in this project:</li>
</ul>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;aes.c -&gt; AES256 implementation from http://www.literatecode.com/aes256 (with some things changed)</div></div><!-- fragment --><ul>
<li>Custom files done by mooltipass team:</li>
</ul>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;aes256_nessie_test.c    (only used for test)</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;aes256_ctr_test.c       (only used for test)</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;aes256_ctr.c</div></div><!-- fragment --><ul>
<li>Files to check aes256_nessie and aes256_ctr tests:</li>
</ul>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;aes256_nessie_test.txt</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;aes256_ctr_test.txt</div></div><!-- fragment --><h2>5- Speed performance </h2>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;with #define BACK_TO_TABLES enabled</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;text     data     bss     dec    hex filename</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;1872       0       0    1872     750 aes.o</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;Time(1000 encryptions): 59433 ms</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;with #define BACK_TO_TABLES disabled</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;text    data     bss     dec     hex filename</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;2320       0       0    2320     910 aes.o</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;Time(1000 encryptions): 1204 ms</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu May 5 2016 10:42:40 for Mooltipass by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
